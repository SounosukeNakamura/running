<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤©æ°—Ã—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ãƒ¼ã‚¹ææ¡ˆã‚¢ãƒ—ãƒª</title>
    <style>
      [data-lat][data-lng] {
        width: 100%;
        height: 400px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Geolonia Maps Embed API -->
    <script type="text/javascript" src="https://cdn.geolonia.com/v1/embed?geolonia-api-key=57e50c6fcf3240359f4cf08862c029d6"></script>
    
    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªåœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
      window.geoloniaMapInstance = null;
      
      // Geolonia ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¾Œã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªåœ°å›³åˆæœŸåŒ–é–¢æ•°ã‚’ç™»éŒ²
      window.initializeGeoloniaMaps = function() {
        console.log('ğŸ—ºï¸ initializeGeoloniaMaps() called');
        
        if (!window.geolonia) {
          console.error('âŒ Geolonia not loaded');
          return;
        }
        
        // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’æŒã¤è¦ç´ ã‚’å‡¦ç†
        var mapElements = document.querySelectorAll('[data-lat][data-lng]');
        console.log('Found ' + mapElements.length + ' map elements to initialize');
        
        if (mapElements.length === 0) {
          console.warn('âš ï¸ No map elements found. Looking for elements with data-lat/data-lng attributes...');
          // DEBUG: ã™ã¹ã¦ã®è¦ç´ ã‚’åˆ—æŒ™
          var allElements = document.querySelectorAll('[data-lat], [data-lng]');
          console.log('Elements with partial attributes:', allElements.length);
          allElements.forEach(function(el, i) {
            console.log('  [' + i + '] data-lat=' + el.getAttribute('data-lat') + ', data-lng=' + el.getAttribute('data-lng'));
          });
        }
        
        mapElements.forEach(function(element, index) {
          var lat = parseFloat(element.getAttribute('data-lat'));
          var lng = parseFloat(element.getAttribute('data-lng'));
          var zoom = parseInt(element.getAttribute('data-zoom') || '14');
          
          console.log('Initializing map ' + (index + 1) + ': lat=' + lat + ', lng=' + lng + ', zoom=' + zoom);
          
          try {
            // Geolonia.Map ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦æ˜ç¤ºçš„ã«åœ°å›³ã‚’ä½œæˆ
            var map = new window.geolonia.Map({
              container: element,
              center: [lng, lat],
              zoom: zoom,
              pitch: 0,
              bearing: 0
            });
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
            window.geoloniaMapInstance = map;
            console.log('âœ“ Map instance created and saved to window.geoloniaMapInstance');
            
            map.on('load', function() {
              console.log('âœ“ Map ' + (index + 1) + ' loaded successfully');
            });
            
            map.on('error', function(error) {
              console.error('Map ' + (index + 1) + ' error:', error);
            });
          } catch (err) {
            console.error('Failed to initialize map ' + (index + 1) + ':', err);
          }
        });
      };
      
      // ã‚³ãƒ¼ã‚¹ã‚’åœ°å›³ä¸Šã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
      // ç¬¬äºŒå¼•æ•°ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã›ã¾ã™: { hideWaypointMarkers: true }
      var displayCourseOnMapFunction = function(coursePoints, options) {
        console.log('displayCourseOnMap called. Map instance:', window.geoloniaMapInstance ? 'exists' : 'undefined');
        
        if (!window.geoloniaMapInstance) {
          console.warn('âš ï¸ Map instance not available yet. Retrying in 500ms...');
          setTimeout(function() {
            console.log('Retry: Map instance is now', window.geoloniaMapInstance ? 'available' : 'still undefined');
            if (window.geoloniaMapInstance) {
              displayCourseOnMapFunction(coursePoints, options);
            } else {
              console.error('âŒ Failed to display course: map instance unavailable after retry');
            }
          }, 500);
          return;
        }
        
        var map = window.geoloniaMapInstance;
        console.log('âœ“ Map instance found. Displaying ' + coursePoints.length + ' course points on map');
        
        try {
          // ã‚³ãƒ¼ã‚¹ã®åº§æ¨™ã‚’GeoJSONå½¢å¼ã«å¤‰æ›
          var coordinates = coursePoints.map(function(point) {
            return [point.lng, point.lat];
          });
          
          // çµ‚ç‚¹ã‚’èµ·ç‚¹ã«æˆ»ã—ã¦é–‰ã˜ãŸãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
          coordinates.push(coordinates[0]);
          
          // Polylineãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã™ã§ã«ã‚ã‚Œã°å‰Šé™¤
          if (map.getLayer('route')) {
            map.removeLayer('route');
          }
          if (map.getSource('route')) {
            map.removeSource('route');
          }
          
          // ãƒ«ãƒ¼ãƒˆã®ã‚½ãƒ¼ã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              geometry: {
                type: 'LineString',
                coordinates: coordinates
              },
              properties: {}
            }
          });
          
          map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            paint: {
              'line-color': '#3b82f6',
              'line-width': 3,
              'line-opacity': 0.8
            }
          });
          
          console.log('âœ“ Route polyline added to map');
          
          // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼ˆèµ·ç‚¹ï¼‰ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
          var startMarkerElement = document.createElement('div');
          startMarkerElement.style.width = '35px';
          startMarkerElement.style.height = '35px';
          startMarkerElement.style.backgroundColor = '#10b981';
          startMarkerElement.style.borderRadius = '50%';
          startMarkerElement.style.border = '3px solid white';
          startMarkerElement.style.display = 'flex';
          startMarkerElement.style.alignItems = 'center';
          startMarkerElement.style.justifyContent = 'center';
          startMarkerElement.style.color = 'white';
          startMarkerElement.style.fontSize = '12px';
          startMarkerElement.style.fontWeight = 'bold';
          startMarkerElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
          startMarkerElement.textContent = 'S';
          
          new window.geolonia.Marker({
            element: startMarkerElement
          })
          .setLngLat([coursePoints[0].lng, coursePoints[0].lat])
          .addTo(map);
          
          console.log('âœ“ Start marker added at', coursePoints[0].lat, coursePoints[0].lng);
          
          // æŠ˜ã‚Šè¿”ã—åœ°ç‚¹ï¼ˆå¾€è·¯ã®çµ‚ç‚¹ï¼‰ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
          // coursePoints.length ãŒå¥‡æ•°ã®å ´åˆã¯ä¸­å¤®ã€å¶æ•°ã®å ´åˆã¯ãã‚Œã«è¿‘ã„ç‚¹
          var turnbackIndex = Math.floor(coursePoints.length / 2);
          var turnbackPoint = coursePoints[turnbackIndex];
          
          var turnbackMarkerElement = document.createElement('div');
          turnbackMarkerElement.style.width = '30px';
          turnbackMarkerElement.style.height = '30px';
          turnbackMarkerElement.style.backgroundColor = '#f59e0b';
          turnbackMarkerElement.style.borderRadius = '50%';
          turnbackMarkerElement.style.border = '2px solid white';
          turnbackMarkerElement.style.display = 'flex';
          turnbackMarkerElement.style.alignItems = 'center';
          turnbackMarkerElement.style.justifyContent = 'center';
          turnbackMarkerElement.style.color = 'white';
          turnbackMarkerElement.style.fontSize = '11px';
          turnbackMarkerElement.style.fontWeight = 'bold';
          turnbackMarkerElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
          turnbackMarkerElement.textContent = 'T';
          
          new window.geolonia.Marker({
            element: turnbackMarkerElement
          })
          .setLngLat([turnbackPoint.lng, turnbackPoint.lat])
          .addTo(map);
          
          console.log('âœ“ Turnback point marker added at', turnbackPoint.lat, turnbackPoint.lng);
          
          // åœ°å›³ã®è¦–é‡ã‚’ãƒ«ãƒ¼ãƒˆå…¨ä½“ã«åˆã‚ã›ã‚‹ï¼ˆfitBoundsï¼‰
          var minLat = coursePoints[0].lat;
          var maxLat = coursePoints[0].lat;
          var minLng = coursePoints[0].lng;
          var maxLng = coursePoints[0].lng;
          
          coursePoints.forEach(function(point) {
            minLat = Math.min(minLat, point.lat);
            maxLat = Math.max(maxLat, point.lat);
            minLng = Math.min(minLng, point.lng);
            maxLng = Math.max(maxLng, point.lng);
          });
          
          map.fitBounds(
            [[minLng, minLat], [maxLng, maxLat]],
            { padding: 50, maxZoom: 15 }
          );
          
          console.log('âœ“ Map bounds adjusted to fit all points');
          console.log('âœ… Course display completed successfully');
        } catch (err) {
          console.error('âŒ Error displaying course on map:', err);
        }
      };
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ« window ã«ç™»éŒ²
      window.displayCourseOnMap = displayCourseOnMapFunction;
              .setLngLat([point.lng, point.lat])
              .addTo(map);
            } catch (err) {
              console.error('Error creating marker ' + idx + ':', err);
            }
          });
          
          console.log('âœ“ Course displayed on map with ' + coursePoints.length + ' markers');
        } catch (err) {
          console.error('Error displaying course on map:', err);
        }
      };
      
      // Geolonia èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
      window.addEventListener('load', function() {
        if (window.geolonia) {
          console.log('âœ“ Geolonia loaded on page load');
          // React ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
          setTimeout(function() {
            window.initializeGeoloniaMaps();
          }, 500);
        }
      });
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
