<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤©æ°—Ã—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ãƒ¼ã‚¹ææ¡ˆã‚¢ãƒ—ãƒª</title>
    <style>
      [data-lat][data-lng] {
        width: 100%;
        height: 400px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Geolonia Maps Embed API -->
    <script type="text/javascript" src="https://cdn.geolonia.com/v1/embed?geolonia-api-key=57e50c6fcf3240359f4cf08862c029d6"></script>
    
    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªåœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
      window.geoloniaMapInstance = null;
      
      // Geolonia ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¾Œã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªåœ°å›³åˆæœŸåŒ–é–¢æ•°ã‚’ç™»éŒ²
      window.initializeGeoloniaMaps = function() {
        console.log('ğŸ—ºï¸ initializeGeoloniaMaps() called');
        
        if (!window.geolonia) {
          console.error('âŒ Geolonia not loaded');
          return;
        }
        
        // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’æŒã¤è¦ç´ ã‚’å‡¦ç†
        const mapElements = document.querySelectorAll('[data-lat][data-lng]');
        console.log('Found ' + mapElements.length + ' map elements to initialize');
        
        mapElements.forEach(function(element, index) {
          const lat = parseFloat(element.getAttribute('data-lat'));
          const lng = parseFloat(element.getAttribute('data-lng'));
          const zoom = parseInt(element.getAttribute('data-zoom') || '14');
          
          console.log('Initializing map ' + (index + 1) + ': lat=' + lat + ', lng=' + lng + ', zoom=' + zoom);
          
          try {
            // Geolonia.Map ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦æ˜ç¤ºçš„ã«åœ°å›³ã‚’ä½œæˆ
            const map = new window.geolonia.Map({
              container: element,
              center: [lng, lat],
              zoom: zoom,
              pitch: 0,
              bearing: 0
            });
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åœ°å›³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
            window.geoloniaMapInstance = map;
            
            map.on('load', function() {
              console.log('âœ“ Map ' + (index + 1) + ' loaded successfully');
            });
            
            map.on('error', function(error) {
              console.error('Map ' + (index + 1) + ' error:', error);
            });
          } catch (err) {
            console.error('Failed to initialize map ' + (index + 1) + ':', err);
          }
        });
      };
      
      // ã‚³ãƒ¼ã‚¹ã‚’åœ°å›³ä¸Šã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
      window.displayCourseOnMap = function(coursePoints) {
        if (!window.geoloniaMapInstance) {
          console.error('Map instance not available');
          return;
        }
        
        const map = window.geoloniaMapInstance;
        console.log('ğŸ—ºï¸ Displaying ' + coursePoints.length + ' course points on map');
        
        try {
          // ã‚³ãƒ¼ã‚¹ã®åº§æ¨™ã‚’GeoJSONå½¢å¼ã«å¤‰æ›
          const coordinates = coursePoints.map(function(point) {
            return [point.lng, point.lat];
          });
          
          // çµ‚ç‚¹ã‚’èµ·ç‚¹ã«æˆ»ã—ã¦é–‰ã˜ãŸãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
          coordinates.push(coordinates[0]);
          
          // Polylineãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã™ã§ã«ã‚ã‚Œã°å‰Šé™¤
          if (map.getLayer('route')) {
            map.removeLayer('route');
          }
          if (map.getSource('route')) {
            map.removeSource('route');
          }
          
          // ãƒ«ãƒ¼ãƒˆã®ã‚½ãƒ¼ã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              geometry: {
                type: 'LineString',
                coordinates: coordinates
              },
              properties: {}
            }
          });
          
          map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            paint: {
              'line-color': '#3b82f6',
              'line-width': 3,
              'line-opacity': 0.8
            }
          });
          
          // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
          coursePoints.forEach(function(point, idx) {
            var markerColor = idx === 0 ? '#10b981' : '#ef4444'; // èµ·ç‚¹ã¯ç·‘ã€ä»–ã¯èµ¤
            var markerSize = idx === 0 ? 35 : 25;
            
            var markerElement = document.createElement('div');
            markerElement.style.width = markerSize + 'px';
            markerElement.style.height = markerSize + 'px';
            markerElement.style.backgroundColor = markerColor;
            markerElement.style.borderRadius = '50%';
            markerElement.style.border = '2px solid white';
            markerElement.style.display = 'flex';
            markerElement.style.alignItems = 'center';
            markerElement.style.justifyContent = 'center';
            markerElement.style.color = 'white';
            markerElement.style.fontSize = '12px';
            markerElement.style.fontWeight = 'bold';
            markerElement.textContent = idx;
            
            try {
              new window.geolonia.Marker({
                element: markerElement
              })
              .setLngLat([point.lng, point.lat])
              .addTo(map);
            } catch (err) {
              console.error('Error creating marker ' + idx + ':', err);
            }
          });
          
          console.log('âœ“ Course displayed on map with ' + coursePoints.length + ' markers');
        } catch (err) {
          console.error('Error displaying course on map:', err);
        }
      };
      
      // Geolonia èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
      window.addEventListener('load', function() {
        if (window.geolonia) {
          console.log('âœ“ Geolonia loaded on page load');
          // React ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã¾ã§å°‘ã—å¾…ã¤
          setTimeout(function() {
            window.initializeGeoloniaMaps();
          }, 500);
        }
      });
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
