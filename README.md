# 🏃 ランニングコース提案アプリ

現在地を起点に、指定した走行時間内で完結するランニングコースを自動生成する Web アプリケーションです。  
往復ルートのため、時間どおりに現在地へ確実に戻ってこることができます。

---

## 📋 アプリ概要

### コース設計の特徴

- **スタート地点** ： 現在地（ブラウザの位置情報 API で自動取得）
- **折り返し地点** ： 走行時間の半分で到達できる中間地点
- **ゴール地点** ： 現在地（スタート地点と同じ）
- **ルート構造** ： 往路と復路が完全に同じ道を通る往復コース

### 時間制約の保証

入力時間を **T分** とするとき：

$$T - 2 \text{分} \leq \text{推定走行時間} \leq T \text{分}$$

- 推定走行時間は入力時間を **絶対に超えない**
- 常に 2 分以内のバッファを確保し、安全にゴール可能

---

## ✨ 主な機能

### 位置情報と住所表示

- ブラウザの Geolocation API で現在地を自動取得
- OpenStreetMap Nominatim により逆ジオコーディングを実行
- 住所を以下の形式で表示：「東京都 葛飾区 白鳥 2丁目」
- 市区町村 → 町名 → 丁目の順で整形

### コース生成ロジック

- **複数方向の探索** ： 8 方向（0°, 45°, 90°, 135°, 180°, 225°, 270°, 315°）を試行
- **距離調整** ： スケール係数（0.8 ～ 1.2）を用いた 9 段階の補正
- **最適化** ： 時間制約を満たす候補から、入力時間に最も近いものを選択
- **効率的処理** ： 最大 3 個の有効候補で早期終了し、高速化を実現

### 地図表示（Geolonia Maps）

- ランニングルート全体を 1 本のポリラインで表示
- スタート地点（現在地）を緑のマーカーで表示
- 折り返し地点（中間地点）をオレンジのマーカーで表示
- ウェイポイント・平均ペース・警告文は表示しない（UI シンプル化）

### 天気情報と走行アドバイス

- OpenWeather API から現在地の天気データを取得
- 気温・湿度・風速・降雨量を表示
- 天候に応じた簡単な走行アドバイスを自動生成
  - 気温が高い場合：水分補給の促進
  - 降雨がある場合：路面状況への注意喚起
  - 風が強い場合：ペース調整の提案

---

## 🛠️ 使用技術

| カテゴリ | 技術・ツール |
|---------|------------|
| **フロントエンド** | React 18 + TypeScript 5 |
| **ビルド** | Vite 5 |
| **地図表示** | Geolonia Maps（MapBox GL JS ベース） |
| **ルート取得** | OSRM（Open Source Routing Machine） - foot プロファイル |
| **逆ジオコーディング** | OpenStreetMap Nominatim |
| **天気情報** | OpenWeather API |
| **デプロイ** | Vercel（自動ビルド・デプロイ） |

---

## 🎯 設計上の工夫

### 推定走行時間の計算

```
推定走行時間（分） = 往復距離（km） × 想定ペース（5分/km）
```

- OSRM の `duration` フィールドは使用しない
- 一定ペース（5 分/km）に基づいて距離から直接計算
- 理由：時間超過を確実に防止し、安定した走行体験を提供

### 状態管理とエラー対策

- `location` が `null` の場合は `useEffect` 内で早期 `return`
- `displayCourseOnMap()` は `location` が確定した後にのみ呼び出し
- 複数の API 呼び出しを適切に分離し、競合状態を回避
- `null` や `undefined` をユーザー UI に渡さない

### 地図初期化の最適化

- Geolonia マップインスタンスを `window.geoloniaMapInstance` に保存
- 初期化関数 `initializeGeoloniaMaps()` は DOM 構築後に**1 回のみ**実行
- `data-lat` / `data-lng` 属性が設定された要素のみを対象に初期化
- ルート表示前に地図初期化を完了し、描画エラーを防止

### フォールバック戦略

コース生成時に有効候補が見つからない場合：

1. **第 1 段階** ： 時間制約を ±2 分に緩和（T-4 ～ T+2）
2. **第 2 段階** ： さらに ±5 分に緩和（T-7 ～ T+5）
3. **第 3 段階** ： 広い範囲（3 ～ 120 分）で最小距離差の候補を探索

→ すべてが失敗した場合、ユーザーフレンドリーなエラーメッセージを表示

---

## 🚀 セットアップ手順

### 前提条件

- Node.js 16 以上がインストールされていること
- npm または yarn がインストールされていること

### インストール

```bash
# リポジトリをクローン
git clone <repository-url>
cd running

# 依存パッケージをインストール
npm install
```

### 環境変数の設定

プロジェクトルートに `.env.local` ファイルを作成し、以下の API キーを設定してください：

```
VITE_OPENWEATHER_API_KEY=your_openweather_api_key_here
VITE_GEOLONIA_API_KEY=your_geolonia_api_key_here
```

各 API キーの取得方法：

- **OpenWeather API** ： https://openweathermap.org/api （無料プランで利用可能）
- **Geolonia** ： https://geolonia.com/ （開発環境では無料）

### 開発サーバーの起動

```bash
npm run dev
```

ブラウザで `http://localhost:5173` を開いてアプリを実行します。

### 本番ビルド

```bash
npm run build
```

`dist/` フォルダに最適化されたバンドルが生成されます。

---

## ⚙️ 技術仕様

### コース生成の流れ

1. ユーザーが「走りたい時間」を入力
2. 複数の方向（bearing）と距離スケールを組み合わせて候補を生成
3. 各候補について：
   - OSRM で実道路に沿ったルートを取得
   - ルート距離から推定走行時間を計算
   - 時間制約（T-2 ≤ time ≤ T）をチェック
   - 制約内の候補が 3 個見つかったら探索終了（早期終了による高速化）
4. 有効候補から、入力時間との差が最小のものを選択
5. 地図上に結果を表示

### API 連携

| API | 用途 | 使用フィールド |
|-----|------|-------------|
| **OSRM** | ルート情報取得 | geometry（座標）、distance（距離） |
| **Nominatim** | 逆ジオコーディング | address（住所コンポーネント） |
| **OpenWeather** | 天気情報取得 | main（気温）、weather（天候）、wind（風速）、clouds（雲量）、rain（降雨量） |
| **Geolocation API** | 現在地取得 | coords（緯度・経度・精度） |

---

## 📝 注意事項

### ブラウザの位置情報許可

アプリを初回起動時、ブラウザから位置情報の取得許可を求められます。  
**「許可」を選択する必要があります** 。許可しない場合、アプリは動作しません。

### プライベート情報の取り扱い

- API キーはコードに直接記載しないでください
- `.env.local` ファイルは `.gitignore` に含めてください
- 本番環境では、環境変数をセキュアに管理してください

### ネットワーク遅延

- OSRM や Nominatim への API リクエストに数秒要する場合があります
- ローカルネットワークが遅い場合、コース生成に時間がかかる可能性があります

---

## 📄 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。

---

## 🔗 参考リンク

- [React 公式ドキュメント](https://react.dev/)
- [Geolonia Maps](https://geolonia.com/)
- [OSRM API](http://project-osrm.org/docs/v5.5.1/api/overview/)
- [OpenStreetMap Nominatim](https://nominatim.org/)
- [OpenWeather API](https://openweathermap.org/api)
